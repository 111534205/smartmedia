<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>SmartMedia 後台數據管理中心</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #141414; color: #fff; padding: 40px; margin: 0; }
        h1, h3, h4 { color: #E50914; margin-top: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: #181818; padding: 25px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        .form-group { display: grid; grid-template-columns: 1fr 1fr 150px 100px; gap: 12px; margin-top: 15px; }
        input, select { padding: 12px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-size: 14px; }
        button { background: #E50914; color: white; border: none; padding: 10px 16px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button.edit-btn { background: #555; margin-right: 5px; }
        button.del-btn { background: #444; }
        button.del-btn:hover { background: #b20710; }
        ul { list-style: none; padding: 0; }
        li { padding: 12px 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .logout-btn { color: #aaa; text-decoration: none; font-size: 14px; }
        
        /* Modal Style */
        #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center; }
        .modal-content { background:#181818; padding:30px; border-radius:8px; width:500px; border:1px solid #E50914; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
        <h1>後台數據管理中心</h1>
        <div style="display: flex; gap: 20px;">
            <a href="/" class="logout-btn">← 回到前台</a>
            <a href="/admin/logout" class="logout-btn">登出系統</a>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>近 2 小時點擊趨勢分析</h3>
            <canvas id="timeChart" height="150"></canvas>
        </div>
        <div class="card">
            <h3>整體數據摘要</h3>
            <div style="font-size:42px; font-weight:bold; color: #fff;">{{ adv.total }}</div>
            <h4 style="margin-top:30px;">熱門影片排行</h4>
            <ul>
                {% for title, count in adv.top %}
                <li><span>{{ title | truncate(20) }}</span><strong>{{ count }} 次</strong></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="card">
        <h3>新增自訂推薦影片</h3>
        <form action="/admin/add_video" method="post" class="form-group">
            <input name="title" placeholder="影片名稱" required>
            <input name="url" placeholder="YouTube 網址" required>
            <select name="category" required>
                {% for cat in category_names %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
            </select>
            <button type="submit">確認新增</button>
        </form>
    </div>

    <div class="card">
        <h3>已發佈的自訂影片清單</h3>
        {% for cat, vids in custom_videos.items() %}
            <h4 style="margin-top:20px; border-left: 4px solid #E50914; padding-left: 10px;">{{ cat }}</h4>
            <ul>
                {% for v in vids %}
                <li>
                    <span>{{ v.title }}</span>
                    <div>
                        <button class="edit-btn" onclick="openEdit('{{cat}}', '{{v.id}}', '{{v.title}}', '{{v.url}}')">編輯</button>
                        <button class="del-btn" onclick="if(confirm('確定刪除？')) location.href='/admin/delete_video/{{cat}}/{{v.id}}'">刪除</button>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% endfor %}
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>修改影片資訊</h3>
        <form action="/admin/edit_video" method="post">
            <input type="hidden" name="category" id="edit-cat">
            <input type="hidden" name="old_id" id="edit-id">
            <div style="display:flex; flex-direction:column; gap:15px;">
                <label>影片名稱</label>
                <input name="title" id="edit-title" required>
                <label>YouTube 網址</label>
                <input name="url" id="edit-url" required>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="submit" style="flex:1;">儲存修改</button>
                    <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="background:#444; flex:1;">取消</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script id="chart-data" type="application/json">
{ "labels": {{ hourly.keys()|list|tojson }}, "values": {{ hourly.values()|list|tojson }} }
</script>

<script>
    function openEdit(cat, id, title, url) {
        document.getElementById('edit-cat').value = cat;
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-url').value = url;
        document.getElementById('editModal').style.display = 'flex';
    }

    const dataNode = document.getElementById("chart-data");
    const parsed = JSON.parse(dataNode.textContent);
    const ctx = document.getElementById("timeChart").getContext('2d');
    if (parsed.labels.length > 0) {
        new Chart(ctx, {
            type: "line",
            data: {
                labels: parsed.labels,
                datasets: [{ label: "點擊量", data: parsed.values, borderColor: "#E50914", backgroundColor: "rgba(229,9,20,0.1)", fill: true, tension: 0.4 }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }
</script>
</body>
</html>